---
title: "Prepare descriptions"
output: html_notebook
---

```{r}

library(tidyverse)
library(here)
library(jsonlite)
```

# Get the things!

```{r}
#let's try reading them in from github? since they're in another repo

#based on https://github.com/vboyce/multiparty-tangrams/blob/main/code/prep_ms.R

url <- "https://raw.githubusercontent.com/vboyce/multiparty-tangrams/main/"
one_chat <- read_csv(str_c(url,"data/study1/filtered_chat.csv")) |> mutate(rotate=str_c(as.character(numPlayers), "_rotate"))
two_a_chat <-  read_csv(str_c(url,"data/study2a/filtered_chat.csv")) |> mutate(rotate="no_rotate")
two_b_chat <- read_csv(str_c(url,"data/study2b/filtered_chat.csv")) |> mutate(rotate="full_feedback") |> select(-`row num`)
two_c_chat <- read_csv(str_c(url,"data/study2c/filtered_chat.csv")) |> mutate(rotate="emoji") |> select(-type)
three_chat <- read_csv(str_c(url,"data/study3/filtered_chat.csv"))  |> 
  inner_join(read_rds(str_c(url, "data/study3/round_results.rds")) |> select(gameId, trialNum, condition=name) |> unique() ) |> 
  select(-rowid, -type)
  
combined_chat <- one_chat |> 
  rbind(two_a_chat) |> 
  rbind(two_b_chat) |> 
  rbind(two_c_chat) |> 
  mutate(activePlayerCount=NA) |> 
  rename(condition=rotate) |> 
  rbind(three_chat) |> 
  filter(!(is.chitchat)) |> 
   mutate(text = gsub("\\n", '', fixed = T, spellchecked), # note that this is using spellcorrected version!!!!
         text = gsub("[/?/.]", ' ', text),
         text = str_squish(text),
         tangram = gsub('/experiment/tangram_', '', target, fixed=TRUE),
         tangram = gsub('.png', '', tangram, fixed=TRUE)) %>%
  select(gameId, trialNum,repNum,tangram, playerId, role, numPlayers, text, condition)
# so here we instead count non-white space chunks for words 

one_round_results <- read_rds(str_c(url,"data/study1/round_results.rds")) %>% mutate(rotate=str_c(as.character(numPlayers), "_rotate"))
two_a_round_results <- read_rds(str_c(url,"data/study2a/round_results.rds")) %>% mutate(rotate="no_rotate")
two_b_round_results <- read_rds(str_c(url,"data/study2b/round_results.rds")) %>% mutate(rotate="full_feedback")
two_c_round_results <- read_rds(str_c(url,"data/study2c/round_results.rds")) |> mutate(rotate="emoji")
three_round_results <- read_rds(str_c(url,"data/study3/round_results.rds")) |> rename(`_id`="X_id", condition=name)

combined_results <- one_round_results |> 
  rbind(two_a_round_results) |> 
  rbind(two_b_round_results) |> 
  rbind(two_c_round_results) |> 
  mutate(activePlayerCount=NA) |> 
  rename(condition=rotate) |> 
  rbind(three_round_results) |> 
  select(realCorrect, gameId, targetNum, repNum, trialNum, condition, numPlayers, activePlayerCount) |> 
  unique()
  
chat <- combined_chat |> left_join(combined_results)

```

# Prep pilot

Change of plans we're now looking at first and last. 
```{r}

first_last<-  chat |> filter(repNum==5 | repNum==0) |> filter(!is.na(text)) |> filter(condition %in% c("2_rotate", "6_rotate"))



prepped <- first_last |> mutate(playerCount=ifelse(is.na(activePlayerCount), numPlayers, activePlayerCount)) |> 
  mutate(allCorrect=realCorrect==playerCount-1) |> 
  select(-numPlayers, -activePlayerCount, ) |> 
  nest(text=c(role, playerId, text))
  
```

```{r}

prepped |> write_json(here("experiments/expt1/src/test.js"))
```
